<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="çº¸æ¿æŠ¥ä»·">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0ea5e9">
  <title>çº¸æ¿æŠ¥ä»·ç³»ç»Ÿ</title>
  
  <!-- PWAå›¾æ ‡ -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230ea5e9' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>ğŸ“¦</text></svg>">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { font-family: 'PingFang SC', -apple-system, BlinkMacSystemFont, sans-serif; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* é˜²æ­¢iOSåŒå‡»ç¼©æ”¾ */
    * { touch-action: manipulation; }
    /* å®‰å…¨åŒºåŸŸé€‚é… */
    body { padding-bottom: env(safe-area-inset-bottom); }
    nav { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body class="min-h-screen bg-slate-50 pb-20">
  <!-- é¡¶æ  -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
    <div class="max-w-lg mx-auto px-4 py-3">
      <h1 class="text-lg font-bold text-slate-700">çº¸æ¿æŠ¥ä»·ç³»ç»Ÿ</h1>
    </div>
  </header>

  <main id="main" class="max-w-lg mx-auto px-4 py-4"></main>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-50">
    <div class="max-w-lg mx-auto flex">
      <button onclick="switchTab('board')" id="tab-board" class="flex-1 py-3 flex flex-col items-center gap-1 text-sky-500">
        <svg class="w-5 h-5 stroke-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
        <span class="text-xs font-medium">çº¸æ¿</span>
      </button>
      <button onclick="switchTab('carton')" id="tab-carton" class="flex-1 py-3 flex flex-col items-center gap-1 text-slate-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
        <span class="text-xs font-medium">çº¸ç®±</span>
      </button>
      <button onclick="switchTab('paper')" id="tab-paper" class="flex-1 py-3 flex flex-col items-center gap-1 text-slate-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        <span class="text-xs font-medium">åŸçº¸</span>
      </button>
      <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-3 flex flex-col items-center gap-1 text-slate-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span class="text-xs font-medium">å†å²</span>
      </button>
      <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-3 flex flex-col items-center gap-1 text-slate-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <span class="text-xs font-medium">è®¾ç½®</span>
      </button>
    </div>
  </nav>

  <script>
    // ===================== æ•°æ® =====================
    let categories = [
      { id: 'kraft', name: 'æ™®é€šç‰›å¡', color: 'from-amber-400 to-orange-500', forFace: true, forCore: true, order: 1 },
      { id: 'high-kraft', name: 'é«˜å¼ºç‰›å¡', color: 'from-orange-500 to-red-500', forFace: true, forCore: true, order: 2 },
      { id: 'white', name: 'ç™½æŒ‚é¢', color: 'from-slate-300 to-slate-500', forFace: true, forCore: false, order: 3 },
      { id: 'durian', name: 'æ¦´è²é»„', color: 'from-yellow-400 to-amber-500', forFace: true, forCore: false, order: 4 },
      { id: 'core', name: 'èŠ¯ç“¦çº¸', color: 'from-sky-400 to-blue-500', forFace: false, forCore: true, order: 5 },
      { id: 'high-burst', name: 'é«˜è€ç ´', color: 'from-rose-400 to-pink-500', forFace: true, forCore: true, order: 6 },
    ];

    let papers = [
      // ç–é¾™ - ç“¦çº¸ (ç¾é‡‘)
      { id: 'jl-hw105', categoryId: 'core', code: '1', supplier: 'ç–é¾™', name: 'æµ·ç“¦105g', gsm: 105, price: 375, currency: 'USD', rate: 34.5 },
      { id: 'jl-hw125', categoryId: 'core', code: '2', supplier: 'ç–é¾™', name: 'æµ·ç“¦125g', gsm: 125, price: 375, currency: 'USD', rate: 34.5 },
      // ç–é¾™ - é«˜è€ç ´(AAAç‰›å¡) (ç¾é‡‘)
      { id: 'jl-jz160', categoryId: 'high-burst', code: 'N', supplier: 'ç–é¾™', name: 'ç–å†160g', gsm: 160, price: 500, currency: 'USD', rate: 34.5 },
      { id: 'jl-jz190', categoryId: 'high-burst', code: 'Y', supplier: 'ç–é¾™', name: 'ç–å†190g', gsm: 190, price: 500, currency: 'USD', rate: 34.5 },
      { id: 'jl-jz230', categoryId: 'high-burst', code: 'T', supplier: 'ç–é¾™', name: 'ç–å†230g', gsm: 230, price: 500, currency: 'USD', rate: 34.5 },
      // ç–é¾™ - æ™®é€šç‰›å¡ (ç¾é‡‘)
      { id: 'jl-hz125', categoryId: 'kraft', code: 'K', supplier: 'ç–é¾™', name: 'æµ·å†125g', gsm: 125, price: 420, currency: 'USD', rate: 34.5 },
      { id: 'jl-hz140', categoryId: 'kraft', code: 'P', supplier: 'ç–é¾™', name: 'æµ·å†140g', gsm: 140, price: 410, currency: 'USD', rate: 34.5 },
      // å¤ªé˜³ - æ™®é€šç‰›å¡ (ç¾é‡‘)
      { id: 'ty-100', categoryId: 'kraft', code: 'B', supplier: 'å¤ªé˜³', name: '100', gsm: 100, price: 411, currency: 'USD', rate: 34.5 },
      { id: 'ty-160', categoryId: 'kraft', code: 'R', supplier: 'å¤ªé˜³', name: '160', gsm: 160, price: 381, currency: 'USD', rate: 34.5 },
      { id: 'ty-190', categoryId: 'kraft', code: 'H', supplier: 'å¤ªé˜³', name: '190', gsm: 190, price: 381, currency: 'USD', rate: 34.5 },
      // ç†æ–‡ - æ™®é€šç‰›å¡ (ç¾é‡‘)
      { id: 'lw-250', categoryId: 'kraft', code: 'S', supplier: 'ç†æ–‡', name: '250', gsm: 250, price: 440, currency: 'USD', rate: 34.5 },
      // ç†æ–‡ - ç™½æŒ‚é¢ (ç¾é‡‘)
      { id: 'lw-w140', categoryId: 'white', code: 'W', supplier: 'ç†æ–‡', name: 'ç™½é¢140', gsm: 140, price: 645, currency: 'USD', rate: 34.5 },
      { id: 'lw-w170', categoryId: 'white', code: 'X', supplier: 'ç†æ–‡', name: 'ç™½é¢170', gsm: 170, price: 645, currency: 'USD', rate: 34.5 },
      // SCG - ç“¦çº¸/å¤¹å¿ƒ (æ³°é“¢)
      { id: 'scg-cf90', categoryId: 'core', code: '9', supplier: 'SCG', name: 'CF90', gsm: 90, price: 14250, currency: 'THB', rate: 1 },
      { id: 'scg-ca150', categoryId: 'core', code: '5', supplier: 'SCG', name: 'CA150', gsm: 150, price: 13250, currency: 'THB', rate: 1 },
      { id: 'scg-caf185', categoryId: 'core', code: '8', supplier: 'SCG', name: 'CAF185', gsm: 185, price: 13500, currency: 'THB', rate: 1 },
      // SCG - å·¥ä¸šé»„ (æ³°é“¢)
      { id: 'scg-ta125', categoryId: 'durian', code: 'D', supplier: 'SCG', name: 'TA125', gsm: 125, price: 21500, currency: 'THB', rate: 1 },
    ];

    let fluteFactors = { A: 1.52, B: 1.36, C: 1.48, E: 1.26 };
    let wasteFactor = 1.08;
    let processFees = { glue: 0.15, steam: 0.12, labor: 0.25, electric: 0.08, other: 0.10 };
    let defaultRates = { CNY: 4.85, USD: 34.5 };

    const FLUTE_OPTIONS = {
      2: ['A', 'B', 'C', 'E'],
      3: ['A', 'B', 'C', 'E'],
      4: ['AB', 'BC', 'BE', 'CE'],
      5: ['AB', 'BC', 'BE', 'CE'],
      7: ['ABC', 'BCE', 'ABE'],
    };

    // çŠ¶æ€
    let activeTab = 'board';
    let layers = 5;
    let fluteType = 'BC';
    let board = [
      { pos: 'face', categoryId: 'kraft', paperId: 'jl-hz125' },
      { pos: 'flute1', categoryId: 'core', paperId: 'jl-hw105' },
      { pos: 'core', categoryId: 'core', paperId: 'jl-hw125' },
      { pos: 'flute2', categoryId: 'core', paperId: 'jl-hw105' },
      { pos: 'back', categoryId: 'kraft', paperId: 'jl-hz125' },
    ];
    let cartonSize = { length: 400, width: 300, height: 250 };
    let cartonExtra = { width: 40, height: 20 }; // åŠ å®½ã€åŠ é«˜
    let cartonProcessFee = 0; // å•ä¸ªçº¸ç®±åŠ å·¥è´¹
    let cartonQty = 1000;
    let cartonProfit = 20; // æ¯›åˆ©ç‡%
    let history = [];
    let settingTab = 'category';
    let expandedCategory = 'kraft';
    let openDropdown = null;
    let showCalcDetail = false; // æ˜¯å¦æ˜¾ç¤ºè®¡ç®—è¿‡ç¨‹

    // ===================== å·¥å…·å‡½æ•° =====================
    const getPaper = (id) => papers.find(p => p.id === id);
    const getCategory = (id) => categories.find(c => c.id === id);
    const getPapersByCategory = (catId) => papers.filter(p => p.categoryId === catId);
    // ä½¿ç”¨defaultRatesç»Ÿä¸€æ±‡ç‡
    const toTHB = (price, currency) => {
      if (currency === 'THB') return price;
      if (currency === 'USD') return price * defaultRates.USD;
      if (currency === 'CNY') return price * defaultRates.CNY;
      return price;
    };
    const isFacePos = (pos) => pos === 'face' || pos === 'back';
    const getAvailableCats = (pos) => {
      const isFace = isFacePos(pos);
      return categories.filter(c => isFace ? c.forFace : c.forCore).sort((a, b) => a.order - b.order);
    };

    // è®¡ç®—çº¸æ¿
    function calcBoard() {
      let fluteIdx = 0, paperCost = 0;
      const details = [];
      const fluteChars = fluteType.split('');

      for (const layer of board) {
        const paper = getPaper(layer.paperId);
        const cat = getCategory(layer.categoryId);
        if (!paper) { details.push({ paper: null, cat, sqPrice: 0 }); continue; }

        // æ­¥éª¤1: å¨ä»·è½¬æ³°é“¢ï¼ˆä½¿ç”¨ç»Ÿä¸€æ±‡ç‡è®¾ç½®ï¼‰
        const priceTHB = toTHB(paper.price, paper.currency);
        
        // æ­¥éª¤2: ç“¦æ¥ç³»æ•°
        let factor = 1;
        let fluteChar = null;
        if (layer.pos.startsWith('flute') && fluteChars[fluteIdx]) {
          fluteChar = fluteChars[fluteIdx];
          factor = fluteFactors[fluteChar] || 1;
          fluteIdx++;
        }

        // æ­¥éª¤3: è®¡ç®—æ¯å¹³æ–¹ä»·æ ¼
        // å…¬å¼: (å…‹é‡/1000) * (å¨ä»·THB/1000) * ç“¦æ¥ç³»æ•° = æ¯å¹³æ–¹ä»·æ ¼
        const sqPrice = (paper.gsm / 1000) * (priceTHB / 1000) * factor;
        paperCost += sqPrice;
        
        details.push({ 
          paper, cat, sqPrice, fluteChar, factor,
          priceTHB, // æ³°é“¢å¨ä»·
          calcStr: `${paper.gsm}/1000 Ã— ${priceTHB.toFixed(0)}/1000 Ã— ${factor} = ${sqPrice.toFixed(4)}`
        });
      }

      const totalProcess = Object.values(processFees).reduce((a, b) => a + b, 0);
      // çº¸å¼ æˆæœ¬ Ã— æŸè€—ç³»æ•° + åŠ å·¥è´¹ = å”®å‡ºä»·æ ¼
      const costPrice = paperCost * wasteFactor + totalProcess;
      const codeStr = details.map(d => d.paper?.code || '?').join('');
      const gsmStr = details.map(d => d.paper?.gsm || '?').join('+');

      return { 
        details, 
        paperCost,      // çº¸å¼ æˆæœ¬ï¼ˆä¸å«æŸè€—å’ŒåŠ å·¥è´¹ï¼‰
        totalProcess,   // åŠ å·¥è´¹åˆè®¡
        wasteFactor,    // æŸè€—ç³»æ•°
        costPrice,      // æˆæœ¬ä»·
        sellPrice: costPrice, 
        codeStr, 
        gsmStr 
      };
    }

    // è®¡ç®—çº¸ç®±
    function calcCarton(boardResult) {
      const { length, width, height } = cartonSize;
      const { width: extraW, height: extraH } = cartonExtra;
      // çº¸æ¿å°ºå¯¸ï¼šé•¿ = (é•¿+å®½)*2 + åŠ å®½ï¼Œå®½ = å®½+é«˜ + åŠ é«˜
      const boardLength = (length + width) * 2 + extraW;
      const boardWidth = width + height + extraH;
      // é¢ç§¯ï¼ˆå¹³æ–¹ç±³ï¼‰
      const area = (boardLength * boardWidth) / 1000000;
      // çº¸ç®±å•ä»· = é¢ç§¯ Ã— å¹³æ–¹å•ä»· + åŠ å·¥è´¹
      const unitCost = area * boardResult.sellPrice + cartonProcessFee;
      // å«æ¯›åˆ©å•ä»·
      const unitPrice = unitCost / (1 - cartonProfit / 100);
      // æ€»ä»·
      const totalPrice = unitPrice * cartonQty;
      return { boardLength, boardWidth, area, unitCost, unitPrice, totalPrice };
    }

    // åˆ‡æ¢å±‚æ•°
    function changeLayers(n) {
      layers = n;
      const defFace = papers.find(p => p.categoryId === 'kraft')?.id;
      const defCore = papers.find(p => p.categoryId === 'core')?.id;
      
      if (n === 2) {
        board = [
          { pos: 'flute1', categoryId: 'core', paperId: defCore },
          { pos: 'back', categoryId: 'kraft', paperId: defFace },
        ];
        fluteType = 'B';
      } else if (n === 3) {
        board = [
          { pos: 'face', categoryId: 'kraft', paperId: defFace },
          { pos: 'flute1', categoryId: 'core', paperId: defCore },
          { pos: 'back', categoryId: 'kraft', paperId: defFace },
        ];
        fluteType = 'B';
      } else if (n === 4) {
        board = [
          { pos: 'flute1', categoryId: 'core', paperId: defCore },
          { pos: 'core', categoryId: 'core', paperId: defCore },
          { pos: 'flute2', categoryId: 'core', paperId: defCore },
          { pos: 'back', categoryId: 'kraft', paperId: defFace },
        ];
        fluteType = 'BC';
      } else if (n === 5) {
        board = [
          { pos: 'face', categoryId: 'kraft', paperId: defFace },
          { pos: 'flute1', categoryId: 'core', paperId: defCore },
          { pos: 'core', categoryId: 'core', paperId: defCore },
          { pos: 'flute2', categoryId: 'core', paperId: defCore },
          { pos: 'back', categoryId: 'kraft', paperId: defFace },
        ];
        fluteType = 'BC';
      } else {
        board = [
          { pos: 'face', categoryId: 'kraft', paperId: defFace },
          { pos: 'flute1', categoryId: 'core', paperId: defCore },
          { pos: 'core1', categoryId: 'core', paperId: defCore },
          { pos: 'flute2', categoryId: 'core', paperId: defCore },
          { pos: 'core2', categoryId: 'core', paperId: defCore },
          { pos: 'flute3', categoryId: 'core', paperId: defCore },
          { pos: 'back', categoryId: 'kraft', paperId: defFace },
        ];
        fluteType = 'BCE';
      }
      render();
    }

    function setFluteType(type) {
      fluteType = type;
      render();
    }

    function selectCategory(idx, catId) {
      const catPapers = getPapersByCategory(catId);
      board[idx].categoryId = catId;
      board[idx].paperId = catPapers[0]?.id || board[idx].paperId;
      openDropdown = null;
      render();
    }

    function selectPaper(idx, paperId) {
      board[idx].paperId = paperId;
      render();
    }

    function toggleDropdown(idx) {
      openDropdown = openDropdown === idx ? null : idx;
      render();
    }

    function toggleCalcDetail() {
      showCalcDetail = !showCalcDetail;
      render();
    }

    function copyResult() {
      const result = calcBoard();
      const text = `${layers}å±‚${fluteType}æ¥ | ${result.codeStr} | ${result.gsmStr} | à¸¿${result.sellPrice.toFixed(4)}/ã¡`;
      navigator.clipboard.writeText(text);
      alert('å·²å¤åˆ¶!');
    }

    function saveToHistory() {
      const boardResult = calcBoard();
      const cartonResult = calcCarton(boardResult);
      history.unshift({
        id: Date.now(),
        time: new Date().toLocaleString(),
        layers, fluteType,
        code: boardResult.codeStr,
        gsm: boardResult.gsmStr,
        boardPrice: boardResult.sellPrice,
        size: { ...cartonSize },
        extra: { ...cartonExtra },
        processFee: cartonProcessFee,
        profit: cartonProfit,
        qty: cartonQty,
        boardLength: cartonResult.boardLength,
        boardWidth: cartonResult.boardWidth,
        area: cartonResult.area,
        unitCost: cartonResult.unitCost,
        unitPrice: cartonResult.unitPrice,
        totalPrice: cartonResult.totalPrice,
      });
      if (history.length > 50) history.pop();
      saveData();
      render();
      alert('å·²ä¿å­˜!');
    }

    function resetCarton() {
      cartonSize = { length: 0, width: 0, height: 0 };
      cartonExtra = { width: 40, height: 20 };
      cartonProcessFee = 0;
      cartonQty = 1000;
      cartonProfit = 20;
      render();
    }

    function shareCarton() {
      const boardResult = calcBoard();
      const cartonResult = calcCarton(boardResult);
      const text = `çº¸ç®±æŠ¥ä»·
çº¸æ¿: ${layers}å±‚${fluteType}æ¥ ${boardResult.codeStr}
å°ºå¯¸: ${cartonSize.length}Ã—${cartonSize.width}Ã—${cartonSize.height}mm
çº¸æ¿: ${cartonResult.boardLength}Ã—${cartonResult.boardWidth}mm
é¢ç§¯: ${cartonResult.area.toFixed(4)}ã¡
å•ä»·: à¸¿${cartonResult.unitPrice.toFixed(2)}
æ•°é‡: ${cartonQty}ä¸ª
æ€»ä»·: à¸¿${cartonResult.totalPrice.toFixed(2)}`;
      navigator.clipboard.writeText(text);
      alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!');
    }

    // ===================== åˆ‡æ¢Tab =====================
    function switchTab(tab) {
      activeTab = tab;
      openDropdown = null;
      document.querySelectorAll('nav button').forEach(btn => {
        btn.classList.remove('text-sky-500');
        btn.classList.add('text-slate-400');
        btn.querySelector('svg').classList.remove('stroke-2');
      });
      const activeBtn = document.getElementById('tab-' + tab);
      activeBtn.classList.remove('text-slate-400');
      activeBtn.classList.add('text-sky-500');
      activeBtn.querySelector('svg').classList.add('stroke-2');
      render();
    }

    // ===================== æ¸²æŸ“ =====================
    function render() {
      const main = document.getElementById('main');
      const boardResult = calcBoard();
      const cartonResult = calcCarton(boardResult);

      if (activeTab === 'board') {
        main.innerHTML = renderBoardPage(boardResult);
      } else if (activeTab === 'carton') {
        main.innerHTML = renderCartonPage(boardResult, cartonResult);
      } else if (activeTab === 'paper') {
        main.innerHTML = renderPaperPage();
      } else if (activeTab === 'history') {
        main.innerHTML = renderHistoryPage();
      } else if (activeTab === 'settings') {
        main.innerHTML = renderSettingsPage();
      }
    }

    function renderBoardPage(result) {
      const layerBtns = [2, 3, 4, 5, 7].map(n => `
        <button onclick="changeLayers(${n})" class="w-8 h-8 rounded-lg font-bold text-sm transition-all ${layers === n ? 'bg-sky-100 text-sky-700 border border-sky-300' : 'bg-white text-slate-400 border border-slate-200'}">${n}</button>
      `).join('');

      const fluteBtns = (FLUTE_OPTIONS[layers] || []).map(type => `
        <button onclick="setFluteType('${type}')" class="px-2 py-1 rounded text-xs font-medium transition-all ${fluteType === type ? 'bg-sky-100 text-sky-700 border border-sky-300' : 'bg-white text-slate-400 border border-slate-200'}">${type}</button>
      `).join('');

      const layerRows = board.map((layer, idx) => {
        const detail = result.details[idx];
        const categoryPapers = getPapersByCategory(layer.categoryId);
        const cat = getCategory(layer.categoryId);
        const availCats = getAvailableCats(layer.pos);

        const paperBtns = categoryPapers.map(p => `
          <button onclick="selectPaper(${idx}, '${p.id}')" class="px-2.5 py-1 rounded text-xs font-bold transition-all ${layer.paperId === p.id ? 'bg-sky-500 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}">${p.code}</button>
        `).join('');

        const dropdownOptions = availCats.map(c => `
          <button onclick="selectCategory(${idx}, '${c.id}')" class="w-full px-3 py-2 text-left text-sm hover:bg-sky-50 ${layer.categoryId === c.id ? 'bg-sky-50 text-sky-700' : 'text-slate-600'}">${c.name}</button>
        `).join('');

        // æ˜¾ç¤ºè®¡ç®—è¯¦æƒ…
        const paper = detail?.paper;
        const currencySymbol = paper?.currency === 'USD' ? '$' : (paper?.currency === 'CNY' ? 'Â¥' : 'à¸¿');
        const rateUsed = paper?.currency === 'USD' ? defaultRates.USD : (paper?.currency === 'CNY' ? defaultRates.CNY : 1);
        const calcInfo = paper ? `${paper.name} | ${currencySymbol}${paper.price}Ã—${rateUsed}=${detail.priceTHB?.toFixed(0)}à¸¿/å¨ | ${detail.calcStr}` : '';

        return `
          <div class="px-4 py-3 border-b border-slate-100 last:border-0">
            <div class="flex items-center gap-3">
              <div class="relative flex-shrink-0">
                <button onclick="toggleDropdown(${idx})" class="px-2.5 py-1.5 rounded-lg text-xs font-medium flex items-center gap-1 bg-sky-50 text-sky-700 border border-sky-200">
                  ${cat?.name || 'é€‰æ‹©'}
                  <svg class="w-3 h-3 transition-transform ${openDropdown === idx ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                ${openDropdown === idx ? `<div class="absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-50 min-w-[100px]">${dropdownOptions}</div>` : ''}
              </div>
              <div class="flex gap-1.5 flex-1 overflow-x-auto hide-scrollbar">${paperBtns}</div>
              <span class="text-sm font-bold text-sky-600 flex-shrink-0">à¸¿${detail?.sqPrice?.toFixed(4) || '0.0000'}</span>
            </div>
            ${showCalcDetail ? `<div class="text-xs text-slate-400 mt-1 pl-1">${calcInfo}</div>` : ''}
          </div>
        `;
      }).join('');

      // è®¡ç®—è¿‡ç¨‹è¯¦æƒ…
      const calcDetail = `
        <div class="bg-slate-50 rounded-xl border border-slate-200 p-4 space-y-2 text-xs">
          <div class="font-bold text-slate-600 mb-2">ğŸ“ è®¡ç®—è¿‡ç¨‹</div>
          <div class="text-slate-500">
            <span class="text-slate-700">å…¬å¼:</span> (å…‹é‡g Ã· 1000) Ã— (å¨ä»·à¸¿ Ã· 1000) Ã— ç“¦æ¥ç³»æ•° = æ¯å¹³æ–¹ä»·æ ¼
          </div>
          <div class="text-slate-500">
            <span class="text-slate-700">æ±‡ç‡:</span> $1 = ${defaultRates.USD}à¸¿ | Â¥1 = ${defaultRates.CNY}à¸¿
          </div>
          <div class="border-t border-slate-200 pt-2 mt-2">
            <div class="flex justify-between">
              <span>çº¸å¼ æˆæœ¬åˆè®¡:</span>
              <span class="font-medium">à¸¿${result.paperCost.toFixed(4)}/ã¡</span>
            </div>
            <div class="flex justify-between">
              <span>Ã— æŸè€—ç³»æ•° ${result.wasteFactor}:</span>
              <span class="font-medium">à¸¿${(result.paperCost * result.wasteFactor).toFixed(4)}/ã¡</span>
            </div>
            <div class="flex justify-between">
              <span>+ åŠ å·¥è´¹:</span>
              <span class="font-medium">à¸¿${result.totalProcess.toFixed(2)}/ã¡</span>
            </div>
            <div class="flex justify-between text-sky-600 font-bold border-t border-slate-300 pt-1 mt-1">
              <span>= å”®å‡ºä»·æ ¼:</span>
              <span>à¸¿${result.sellPrice.toFixed(4)}/ã¡</span>
            </div>
          </div>
        </div>
      `;

      return `
        <div class="space-y-4">
          <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
            <div class="px-4 py-3 flex items-center justify-between bg-slate-50 border-b border-slate-200">
              <span class="text-sm font-bold text-slate-600">çº¸æ¿</span>
              <div class="flex items-center gap-2">
                <div class="flex gap-1">${layerBtns}</div>
                <div class="flex gap-1 ml-2 pl-2 border-l border-slate-200">${fluteBtns}</div>
              </div>
            </div>
            <div>${layerRows}</div>
            <div class="px-4 py-3 bg-sky-50 border-t border-sky-100">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-500">
                  ä»£å·: <span class="font-medium text-slate-700">${result.codeStr}</span>
                  <span class="mx-2">|</span>
                  å…‹é‡: <span class="font-medium text-slate-700">${result.gsmStr}</span>
                </div>
                <div>
                  <span class="text-xl font-bold text-sky-600">à¸¿${result.sellPrice.toFixed(4)}</span>
                  <span class="text-slate-400 text-sm ml-1">/ã¡</span>
                </div>
              </div>
            </div>
          </div>
          
          ${showCalcDetail ? calcDetail : ''}
          <div class="flex gap-3">
            <button onclick="toggleCalcDetail()" class="flex-1 py-3 bg-white text-slate-500 font-medium rounded-xl border border-slate-200 flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
              ${showCalcDetail ? 'éšè—è®¡ç®—' : 'æ˜¾ç¤ºè®¡ç®—'}
            </button>
            <button onclick="changeLayers(${layers})" class="flex-1 py-3 bg-white text-slate-500 font-medium rounded-xl border border-slate-200 flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
              é‡ç½®
            </button>
            <button onclick="copyResult()" class="flex-1 py-3 bg-sky-500 text-white font-medium rounded-xl flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
              å¤åˆ¶
            </button>
          </div>
        </div>
      `;
    }

    function renderCartonPage(boardResult, cartonResult) {
      return `
        <div class="space-y-4">
          <!-- å½“å‰çº¸æ¿ä¿¡æ¯ -->
          <div class="bg-white rounded-xl border border-slate-200 p-4">
            <div class="flex items-center justify-between">
              <span class="text-sm font-bold text-sky-600">${layers}å±‚${fluteType}æ¥</span>
              <span class="text-xs text-slate-400">${boardResult.codeStr}</span>
              <span class="font-bold text-sky-600">à¸¿${boardResult.sellPrice.toFixed(4)}/ã¡</span>
            </div>
          </div>

          <!-- çº¸ç®±å°ºå¯¸è¾“å…¥ -->
          <div class="bg-white rounded-xl border border-slate-200 p-4 space-y-4">
            <!-- é•¿å®½é«˜ -->
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="text-xs text-slate-400 block mb-1">é•¿</label>
                <input type="number" value="${cartonSize.length}" onchange="cartonSize.length=parseInt(this.value)||0;render()" class="w-full px-3 py-2 border-b border-slate-300 text-center font-medium bg-transparent focus:outline-none focus:border-sky-500" />
              </div>
              <div>
                <label class="text-xs text-slate-400 block mb-1">å®½</label>
                <input type="number" value="${cartonSize.width}" onchange="cartonSize.width=parseInt(this.value)||0;render()" class="w-full px-3 py-2 border-b border-slate-300 text-center font-medium bg-transparent focus:outline-none focus:border-sky-500" />
              </div>
              <div>
                <label class="text-xs text-slate-400 block mb-1">é«˜</label>
                <input type="number" value="${cartonSize.height}" onchange="cartonSize.height=parseInt(this.value)||0;render()" class="w-full px-3 py-2 border-b border-slate-300 text-center font-medium bg-transparent focus:outline-none focus:border-sky-500" />
              </div>
            </div>
            
            <!-- åŠ å®½åŠ é«˜ -->
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-slate-400 block mb-1">åŠ å®½</label>
                <input type="number" value="${cartonExtra.width}" onchange="cartonExtra.width=parseInt(this.value)||0;render()" class="w-full px-3 py-2 border-b border-slate-300 text-center font-medium bg-transparent focus:outline-none focus:border-sky-500" />
              </div>
              <div>
                <label class="text-xs text-slate-400 block mb-1">åŠ é«˜</label>
                <input type="number" value="${cartonExtra.height}" onchange="cartonExtra.height=parseInt(this.value)||0;render()" class="w-full px-3 py-2 border-b border-slate-300 text-center font-medium bg-transparent focus:outline-none focus:border-sky-500" />
              </div>
            </div>

            <!-- çº¸æ¿å°ºå¯¸ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰ -->
            <div class="grid grid-cols-2 gap-3 pt-2">
              <div>
                <label class="text-xs text-slate-400 block mb-1">çº¸æ¿é•¿</label>
                <div class="w-full px-3 py-2 border-b border-slate-200 text-center font-bold text-sky-600 bg-slate-50">${cartonResult.boardLength}</div>
              </div>
              <div>
                <label class="text-xs text-slate-400 block mb-1">çº¸æ¿å®½</label>
                <div class="w-full px-3 py-2 border-b border-slate-200 text-center font-bold text-sky-600 bg-slate-50">${cartonResult.boardWidth}</div>
              </div>
            </div>
          </div>

          <!-- è®¡ç®—å…¬å¼æ˜¾ç¤º -->
          <div class="bg-white rounded-xl border border-slate-200 p-4">
            <div class="flex items-center justify-center gap-2 text-sm text-slate-600 flex-wrap">
              <span>é¢ç§¯</span>
              <span class="text-slate-400">Ã—</span>
              <span>å¹³æ–¹å•ä»·</span>
              <span class="text-slate-400">+</span>
              <div class="flex items-center gap-1">
                <span>åŠ å·¥è´¹</span>
                <input type="number" value="${cartonProcessFee}" onchange="cartonProcessFee=parseFloat(this.value)||0;render()" class="w-16 px-2 py-1 border border-slate-300 rounded text-center text-sm" />
              </div>
              <span class="text-slate-400">=</span>
            </div>
          </div>

          <!-- è®¡ç®—ç»“æœ -->
          <div class="bg-white rounded-xl border border-slate-200 p-4">
            <div class="grid grid-cols-3 gap-4 text-center">
              <div>
                <div class="text-xs text-slate-400 mb-1">çº¸ç®±å•ä»·</div>
                <div class="text-lg font-bold text-sky-600">à¸¿${cartonResult.unitCost.toFixed(2)}</div>
              </div>
              <div>
                <div class="text-xs text-slate-400 mb-1">çº¸ç®±ä»·</div>
                <div class="text-lg font-bold text-emerald-600">à¸¿${cartonResult.unitPrice.toFixed(2)}</div>
              </div>
              <div>
                <div class="text-xs text-slate-400 mb-1">æ¯›åˆ©ç‡</div>
                <div class="flex items-center justify-center gap-1">
                  <input type="number" value="${cartonProfit}" onchange="cartonProfit=parseFloat(this.value)||0;render()" class="w-12 px-1 py-1 border border-slate-300 rounded text-center text-sm font-bold" />
                  <span class="text-slate-500">%</span>
                </div>
              </div>
            </div>
          </div>

          <!-- å…¬å¼å±•ç¤º -->
          <div class="bg-white rounded-xl border border-slate-200 p-4">
            <div class="flex items-center justify-center gap-1 text-sm font-mono bg-slate-50 p-3 rounded-lg">
              <span class="text-slate-600">{</span>
              <span class="text-slate-600">(é•¿+å®½)</span>
              <span class="text-slate-600">*2+</span>
              <span class="px-2 py-0.5 bg-white border border-slate-300 rounded text-sky-600 font-bold">${cartonExtra.width}</span>
              <span class="text-slate-600">}</span>
              <span class="text-slate-600">*</span>
              <span class="text-slate-600">(å®½+é«˜+</span>
              <span class="px-2 py-0.5 bg-white border border-slate-300 rounded text-sky-600 font-bold">${cartonExtra.height}</span>
              <span class="text-slate-600">)</span>
            </div>
            <div class="text-center text-xs text-slate-400 mt-2">
              = ${cartonResult.boardLength} Ã— ${cartonResult.boardWidth} = ${(cartonResult.area * 1000000).toFixed(0)} mmÂ² = ${cartonResult.area.toFixed(4)} ã¡
            </div>
          </div>

          <!-- æ•°é‡å’Œæ€»ä»· -->
          <div class="bg-white rounded-xl border border-slate-200 p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-sm text-slate-500">æ•°é‡</span>
                <input type="number" value="${cartonQty}" onchange="cartonQty=parseInt(this.value)||0;render()" class="w-20 px-2 py-1 border border-slate-300 rounded text-center font-medium" />
                <span class="text-sm text-slate-400">ä¸ª</span>
              </div>
              <div class="text-right">
                <div class="text-xs text-slate-400">æ€»ä»·</div>
                <div class="text-xl font-bold text-emerald-600">à¸¿${cartonResult.totalPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              </div>
            </div>
          </div>

          <!-- æ“ä½œæŒ‰é’® -->
          <div class="flex gap-3">
            <button onclick="resetCarton()" class="flex-1 py-3 bg-white text-slate-500 font-medium rounded-xl border border-slate-200">
              é‡ç½®
            </button>
            <button onclick="saveToHistory()" class="flex-1 py-3 bg-sky-500 text-white font-medium rounded-xl">
              ä¿å­˜
            </button>
            <button onclick="shareCarton()" class="flex-1 py-3 bg-emerald-500 text-white font-medium rounded-xl">
              åˆ†äº«
            </button>
          </div>
        </div>
      `;
    }

    function renderPaperPage() {
      const catSections = categories.map(cat => {
        const catPapers = getPapersByCategory(cat.id);
        if (catPapers.length === 0) return '';
        
        const paperCards = catPapers.map(p => `
          <div class="p-2 bg-slate-50 rounded-lg">
            <div class="flex items-center gap-1">
              <span class="text-xs font-bold bg-white px-1.5 py-0.5 rounded">${p.code}</span>
              <span class="text-sm font-medium text-slate-700">${p.name}</span>
            </div>
            <div class="text-xs text-slate-400 mt-1">
              ${p.supplier} Â· ${p.gsm}g Â· <span class="text-sky-600 font-medium">à¸¿${toTHB(p.price, p.currency).toFixed(0)}/å¨</span>
            </div>
          </div>
        `).join('');

        return `
          <div class="mb-4 last:mb-0">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-2 h-4 rounded bg-gradient-to-b ${cat.color}"></div>
              <span class="font-medium text-slate-700">${cat.name}</span>
              <span class="text-xs text-slate-400">(${catPapers.length}ç§)</span>
            </div>
            <div class="grid grid-cols-2 gap-2">${paperCards}</div>
          </div>
        `;
      }).join('');

      return `
        <div class="bg-white rounded-xl border border-slate-200 p-4">
          <div class="text-sm text-slate-500 font-medium mb-3">åŸçº¸ä»·æ ¼è¡¨</div>
          ${catSections}
        </div>
      `;
    }

    function renderHistoryPage() {
      if (history.length === 0) {
        return `
          <div class="bg-white rounded-xl border border-slate-200 p-8 text-center">
            <svg class="w-12 h-12 text-slate-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <p class="text-slate-400">æš‚æ— å†å²è®°å½•</p>
          </div>
        `;
      }

      const records = history.map(r => `
        <div class="bg-white rounded-xl border border-slate-200 p-4">
          <div class="flex justify-between items-start mb-2">
            <div>
              <span class="text-sm font-bold text-sky-600">${r.layers}å±‚${r.fluteType}æ¥</span>
              <span class="text-xs text-slate-400 ml-2">${r.code}</span>
            </div>
            <span class="text-xs text-slate-400">${r.time}</span>
          </div>
          <div class="text-xs text-slate-500 mb-2">
            çº¸ç®±: ${r.size.length}Ã—${r.size.width}Ã—${r.size.height}mm
            ${r.boardLength ? `Â· çº¸æ¿: ${r.boardLength}Ã—${r.boardWidth}mm` : ''}
          </div>
          <div class="text-xs text-slate-500 mb-2">
            æ•°é‡: ${r.qty}ä¸ª ${r.profit ? `Â· æ¯›åˆ©: ${r.profit}%` : ''}
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm text-slate-500">å•ä»· à¸¿${r.unitPrice?.toFixed(2) || '0.00'}</span>
            <span class="text-lg font-bold text-emerald-600">à¸¿${r.totalPrice?.toFixed(2) || '0.00'}</span>
          </div>
        </div>
      `).join('');

      return `
        <div class="space-y-4">
          <div class="flex justify-end">
            <button onclick="history=[];saveData();render()" class="text-xs text-red-500">æ¸…ç©ºå†å²</button>
          </div>
          ${records}
        </div>
      `;
    }

    function renderSettingsPage() {
      const tabs = [
        { id: 'category', label: 'åˆ†ç±»ç®¡ç†' },
        { id: 'paper', label: 'çº¸ç§ç®¡ç†' },
        { id: 'rate', label: 'æ±‡ç‡è®¾ç½®' },
        { id: 'flute', label: 'ç“¦æ¥ç³»æ•°' },
        { id: 'process', label: 'åŠ å·¥è´¹' },
      ].map(t => `
        <button onclick="settingTab='${t.id}';render()" class="flex-shrink-0 px-4 py-3 ${settingTab === t.id ? 'border-b-2 border-sky-500 text-sky-600 font-medium' : 'text-slate-400'}">${t.label}</button>
      `).join('');

      let content = '';

      if (settingTab === 'category') {
        const catItems = categories.map(cat => `
          <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg">
            <div class="w-2 h-8 rounded bg-gradient-to-b ${cat.color}"></div>
            <input value="${cat.name}" onchange="updateCategory('${cat.id}','name',this.value)" class="flex-1 bg-white border rounded px-2 py-1 text-sm min-w-0" />
            <label class="flex items-center gap-1 text-xs"><input type="checkbox" ${cat.forFace ? 'checked' : ''} onchange="updateCategory('${cat.id}','forFace',this.checked)" />é¢</label>
            <label class="flex items-center gap-1 text-xs"><input type="checkbox" ${cat.forCore ? 'checked' : ''} onchange="updateCategory('${cat.id}','forCore',this.checked)" />èŠ¯</label>
            <button onclick="deleteCategory('${cat.id}')" class="p-1 text-red-400">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        `).join('');
        content = `<div class="space-y-2">${catItems}</div>`;
      }

      if (settingTab === 'paper') {
        const catSections = categories.map(cat => {
          const catPapers = getPapersByCategory(cat.id);
          const isExpanded = expandedCategory === cat.id;
          
          const paperRows = catPapers.map(p => `
            <div class="grid grid-cols-12 gap-1 items-center p-1 bg-slate-50 rounded text-xs">
              <input value="${p.code}" onchange="updatePaper('${p.id}','code',this.value)" class="col-span-1 bg-white border rounded px-1 py-0.5 text-center font-bold" />
              <input value="${p.supplier}" onchange="updatePaper('${p.id}','supplier',this.value)" class="col-span-2 bg-white border rounded px-1 py-0.5" />
              <input value="${p.name}" onchange="updatePaper('${p.id}','name',this.value)" class="col-span-3 bg-white border rounded px-1 py-0.5" />
              <input type="number" value="${p.gsm}" onchange="updatePaper('${p.id}','gsm',this.value)" class="col-span-2 bg-white border rounded px-1 py-0.5 text-center" placeholder="å…‹é‡" />
              <input type="number" value="${p.price}" onchange="updatePaper('${p.id}','price',this.value)" class="col-span-2 bg-white border rounded px-1 py-0.5 text-center" placeholder="ä»·æ ¼" />
              <select onchange="updatePaper('${p.id}','currency',this.value)" class="col-span-1 bg-white border rounded px-0.5 py-0.5">
                <option value="THB" ${p.currency === 'THB' ? 'selected' : ''}>à¸¿</option>
                <option value="USD" ${p.currency === 'USD' ? 'selected' : ''}>$</option>
                <option value="CNY" ${p.currency === 'CNY' ? 'selected' : ''}>Â¥</option>
              </select>
              <button onclick="deletePaper('${p.id}')" class="col-span-1 p-0.5 text-red-400 justify-self-center">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
          `).join('');

          // æ·»åŠ æ–°çº¸ç§è¡¨å•
          const addForm = isExpanded ? `
            <div class="grid grid-cols-12 gap-1 items-center p-1 bg-sky-50 rounded text-xs border border-dashed border-sky-300">
              <input id="new-code-${cat.id}" placeholder="ä»£å·" class="col-span-1 bg-white border rounded px-1 py-0.5 text-center font-bold" />
              <input id="new-supplier-${cat.id}" placeholder="ä¾›åº”å•†" class="col-span-2 bg-white border rounded px-1 py-0.5" />
              <input id="new-name-${cat.id}" placeholder="åç§°" class="col-span-3 bg-white border rounded px-1 py-0.5" />
              <input id="new-gsm-${cat.id}" type="number" placeholder="å…‹é‡" class="col-span-2 bg-white border rounded px-1 py-0.5 text-center" />
              <input id="new-price-${cat.id}" type="number" placeholder="ä»·æ ¼" class="col-span-2 bg-white border rounded px-1 py-0.5 text-center" />
              <select id="new-currency-${cat.id}" class="col-span-1 bg-white border rounded px-0.5 py-0.5">
                <option value="USD">$</option>
                <option value="THB">à¸¿</option>
                <option value="CNY">Â¥</option>
              </select>
              <button onclick="addNewPaper('${cat.id}')" class="col-span-1 p-0.5 text-sky-500 justify-self-center">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              </button>
            </div>
          ` : '';

          return `
            <div class="border rounded-xl overflow-hidden">
              <button onclick="expandedCategory='${isExpanded ? '' : cat.id}';render()" class="w-full px-3 py-2 bg-slate-50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div class="w-2 h-5 rounded bg-gradient-to-b ${cat.color}"></div>
                  <span class="font-medium text-slate-700 text-sm">${cat.name}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-slate-400">${catPapers.length}ç§</span>
                  <svg class="w-4 h-4 transition-transform ${isExpanded ? 'rotate-90' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </div>
              </button>
              ${isExpanded ? `<div class="p-2 space-y-1.5 bg-white">${paperRows}${addForm}</div>` : ''}
            </div>
          `;
        }).join('');
        content = `<div class="space-y-3">${catSections}</div>`;
      }

      if (settingTab === 'rate') {
        content = `
          <div class="space-y-3">
            <p class="text-xs text-slate-400">é»˜è®¤æ±‡ç‡ï¼ˆå…‘æ¢ä¸ºæ³°é“¢ï¼‰</p>
            <div class="p-3 bg-sky-50 rounded-xl border border-sky-200 space-y-3">
              <div class="flex items-center justify-between">
                <span class="font-medium">Â¥ äººæ°‘å¸</span>
                <div class="flex items-center gap-1">
                  <span class="text-sm">1Â¥ =</span>
                  <input type="number" step="0.01" value="${defaultRates.CNY}" onchange="defaultRates.CNY=parseFloat(this.value)||1;saveData();render()" class="w-16 bg-white border rounded px-2 py-1 text-center text-sm" />
                  <span class="text-sm">à¸¿</span>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <span class="font-medium">$ ç¾é‡‘</span>
                <div class="flex items-center gap-1">
                  <span class="text-sm">1$ =</span>
                  <input type="number" step="0.01" value="${defaultRates.USD}" onchange="defaultRates.USD=parseFloat(this.value)||1;saveData();render()" class="w-16 bg-white border rounded px-2 py-1 text-center text-sm" />
                  <span class="text-sm">à¸¿</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      if (settingTab === 'flute') {
        const fluteRows = Object.entries(fluteFactors).map(([type, val]) => `
          <div class="flex items-center justify-between p-3 bg-sky-50 rounded-xl">
            <span class="font-bold text-sky-700">${type}æ¥</span>
            <input type="number" step="0.01" value="${val}" onchange="fluteFactors['${type}']=parseFloat(this.value)||1;saveData();render()" class="w-20 bg-white border border-sky-300 rounded-lg px-2 py-1 text-center" />
          </div>
        `).join('');
        content = `
          <div class="space-y-2">
            ${fluteRows}
            <div class="p-3 bg-slate-100 rounded-xl">
              <div class="flex items-center justify-between">
                <span class="font-medium text-slate-700">æŸè€—ç³»æ•°</span>
                <input type="number" step="0.01" value="${wasteFactor}" onchange="wasteFactor=parseFloat(this.value)||1;saveData();render()" class="w-20 bg-white border border-slate-300 rounded-lg px-2 py-1 text-center" />
              </div>
            </div>
          </div>
        `;
      }

      if (settingTab === 'process') {
        const feeRows = Object.entries(processFees).map(([key, val]) => {
          const labels = { glue: 'ğŸ§´ èƒ¶æ°´', steam: 'ğŸ’¨ è’¸æ±½', labor: 'ğŸ‘· äººå·¥', electric: 'âš¡ ç”µè´¹', other: 'ğŸ“¦ å…¶ä»–' };
          return `
            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
              <span>${labels[key]}</span>
              <input type="number" step="0.01" value="${val}" onchange="processFees['${key}']=parseFloat(this.value)||0;saveData();render()" class="w-20 bg-white border rounded-lg px-2 py-1 text-center" />
            </div>
          `;
        }).join('');
        const total = Object.values(processFees).reduce((a, b) => a + b, 0);
        content = `
          <div class="space-y-2">
            <p class="text-xs text-slate-400">å•ä½: à¸¿/ã¡</p>
            ${feeRows}
            <div class="p-3 bg-sky-100 rounded-xl flex justify-between">
              <span class="font-bold text-sky-700">åˆè®¡</span>
              <span class="font-bold text-sky-700">à¸¿${total.toFixed(2)}/ã¡</span>
            </div>
          </div>
        `;
      }

      return `
        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
          <div class="flex border-b overflow-x-auto text-sm hide-scrollbar">${tabs}</div>
          <div class="p-4 max-h-[60vh] overflow-y-auto">${content}</div>
        </div>
        <button onclick="saveData();alert('ä¿å­˜æˆåŠŸ!')" class="w-full mt-4 py-3 bg-sky-500 text-white font-medium rounded-xl flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          ä¿å­˜è®¾ç½®
        </button>
      `;
    }

    // è®¾ç½®æ“ä½œ
    function updateCategory(id, field, value) {
      const cat = categories.find(c => c.id === id);
      if (cat) {
        if (field === 'forFace' || field === 'forCore') {
          cat[field] = value;
        } else {
          cat[field] = value;
        }
      }
      saveData();
      render();
    }

    function deleteCategory(id) {
      categories = categories.filter(c => c.id !== id);
      papers = papers.filter(p => p.categoryId !== id);
      saveData();
      render();
    }

    function updatePaper(id, field, value) {
      const paper = papers.find(p => p.id === id);
      if (paper) {
        if (['gsm', 'price', 'rate'].includes(field)) {
          paper[field] = parseFloat(value) || 0;
        } else {
          paper[field] = value;
        }
      }
      saveData();
      render();
    }

    function deletePaper(id) {
      papers = papers.filter(p => p.id !== id);
      saveData();
      render();
    }

    // æ·»åŠ æ–°çº¸ç§
    function addNewPaper(categoryId) {
      const code = document.getElementById('new-code-' + categoryId)?.value;
      const supplier = document.getElementById('new-supplier-' + categoryId)?.value;
      const name = document.getElementById('new-name-' + categoryId)?.value;
      const gsm = document.getElementById('new-gsm-' + categoryId)?.value;
      const price = document.getElementById('new-price-' + categoryId)?.value;
      const currency = document.getElementById('new-currency-' + categoryId)?.value || 'USD';
      
      if (!code || !gsm || !price) {
        alert('è¯·å¡«å†™ä»£å·ã€å…‹é‡å’Œä»·æ ¼');
        return;
      }
      
      const newPaper = {
        id: 'paper-' + Date.now(),
        categoryId: categoryId,
        code: code,
        supplier: supplier || '',
        name: name || '',
        gsm: parseFloat(gsm) || 0,
        price: parseFloat(price) || 0,
        currency: currency
      };
      
      papers.push(newPaper);
      saveData();
      render();
    }

    // ä¿å­˜æ•°æ®åˆ°localStorage
    function saveData() {
      localStorage.setItem('board-quote-papers', JSON.stringify(papers));
      localStorage.setItem('board-quote-categories', JSON.stringify(categories));
      localStorage.setItem('board-quote-rates', JSON.stringify(defaultRates));
      localStorage.setItem('board-quote-flute', JSON.stringify(fluteFactors));
      localStorage.setItem('board-quote-waste', JSON.stringify(wasteFactor));
      localStorage.setItem('board-quote-process', JSON.stringify(processFees));
      localStorage.setItem('board-quote-history', JSON.stringify(history));
    }

    // ä»localStorageåŠ è½½æ•°æ®
    function loadData() {
      try {
        const savedPapers = localStorage.getItem('board-quote-papers');
        const savedCategories = localStorage.getItem('board-quote-categories');
        const savedRates = localStorage.getItem('board-quote-rates');
        const savedFlute = localStorage.getItem('board-quote-flute');
        const savedWaste = localStorage.getItem('board-quote-waste');
        const savedProcess = localStorage.getItem('board-quote-process');
        const savedHistory = localStorage.getItem('board-quote-history');
        
        if (savedPapers) papers = JSON.parse(savedPapers);
        if (savedCategories) categories = JSON.parse(savedCategories);
        if (savedRates) defaultRates = JSON.parse(savedRates);
        if (savedFlute) fluteFactors = JSON.parse(savedFlute);
        if (savedWaste) wasteFactor = JSON.parse(savedWaste);
        if (savedProcess) processFees = JSON.parse(savedProcess);
        if (savedHistory) history = JSON.parse(savedHistory);
      } catch (e) {
        console.log('åŠ è½½æ•°æ®å¤±è´¥', e);
      }
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.relative')) {
        if (openDropdown !== null) {
          openDropdown = null;
          render();
        }
      }
    });

    // åˆå§‹åŒ–
    loadData();
    render();
  </script>
</body>
</html>